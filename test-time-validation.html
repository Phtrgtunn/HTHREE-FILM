<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Time Validation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        button {
            background: #fbbf24;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        button:hover {
            background: #f59e0b;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 6px;
            border-left: 4px solid #fbbf24;
        }
        .warning {
            color: #fbbf24;
        }
        .error {
            color: #ef4444;
        }
        .success {
            color: #10b981;
        }
        pre {
            background: #000;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Time Validation</h1>
    <p>Test t√≠nh nƒÉng ch·ªëng gian l·∫≠n th·ªùi gian client</p>

    <div class="test-section">
        <h2>1. Ki·ªÉm tra Server Time</h2>
        <button onclick="testServerTime()">Test Server Time API</button>
        <div id="serverTimeResult" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>2. Gi·∫£ l·∫≠p Client Time Sai</h2>
        <button onclick="simulateWrongTime(2026)">Gi·∫£ l·∫≠p nƒÉm 2026</button>
        <button onclick="simulateWrongTime(2020)">Gi·∫£ l·∫≠p nƒÉm 2020</button>
        <button onclick="simulateWrongTime(null)">Reset v·ªÅ b√¨nh th∆∞·ªùng</button>
        <div id="simulateResult" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>3. Test Subscription Progress</h2>
        <p>Nh·∫≠p th√¥ng tin subscription ƒë·ªÉ test:</p>
        <div style="margin: 10px 0;">
            <label>Start Date: <input type="date" id="startDate" value="2024-12-01"></label>
        </div>
        <div style="margin: 10px 0;">
            <label>End Date: <input type="date" id="endDate" value="2025-01-01"></label>
        </div>
        <button onclick="testProgress()">T√≠nh Progress</button>
        <div id="progressResult" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>4. Test Time Offset Detection</h2>
        <button onclick="testTimeOffset()">Ki·ªÉm tra Offset</button>
        <div id="offsetResult" class="result" style="display:none;"></div>
    </div>

    <script>
        const API_URL = 'http://localhost/HTHREE_film/HTHREE_film/backend/api';
        let serverTime = null;
        let timeOffset = 0;
        let fakeYear = null;

        // Override Date n·∫øu c·∫ßn
        const OriginalDate = Date;
        function applyFakeDate() {
            if (fakeYear) {
                window.Date = class extends OriginalDate {
                    constructor(...args) {
                        if (args.length === 0) {
                            super();
                            this.setFullYear(fakeYear);
                        } else {
                            super(...args);
                        }
                    }
                    static now() {
                        const d = new OriginalDate();
                        d.setFullYear(fakeYear);
                        return d.getTime();
                    }
                };
            } else {
                window.Date = OriginalDate;
            }
        }

        async function testServerTime() {
            const result = document.getElementById('serverTimeResult');
            result.style.display = 'block';
            result.innerHTML = '<p>‚è≥ ƒêang g·ªçi API...</p>';

            try {
                const response = await fetch(`${API_URL}/server_time.php`);
                const data = await response.json();

                if (data.success) {
                    serverTime = new Date(data.server_time);
                    const clientTime = new Date();
                    timeOffset = serverTime - clientTime;
                    const offsetMinutes = Math.abs(timeOffset) / (1000 * 60);

                    result.innerHTML = `
                        <p class="success">‚úÖ Server Time API ho·∫°t ƒë·ªông!</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                        <p><strong>Server Time:</strong> ${serverTime.toLocaleString('vi-VN')}</p>
                        <p><strong>Client Time:</strong> ${clientTime.toLocaleString('vi-VN')}</p>
                        <p class="${offsetMinutes > 5 ? 'warning' : 'success'}">
                            <strong>Offset:</strong> ${offsetMinutes.toFixed(2)} ph√∫t
                            ${offsetMinutes > 5 ? '‚ö†Ô∏è Sai l·ªách l·ªõn!' : '‚úì B√¨nh th∆∞·ªùng'}
                        </p>
                    `;
                } else {
                    result.innerHTML = `<p class="error">‚ùå API tr·∫£ v·ªÅ l·ªói</p>`;
                }
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå L·ªói: ${error.message}</p>`;
            }
        }

        function simulateWrongTime(year) {
            const result = document.getElementById('simulateResult');
            result.style.display = 'block';

            fakeYear = year;
            applyFakeDate();

            if (year) {
                const fakeDate = new Date();
                result.innerHTML = `
                    <p class="warning">‚ö†Ô∏è ƒê√£ gi·∫£ l·∫≠p client time sang nƒÉm ${year}</p>
                    <p><strong>Fake Client Time:</strong> ${fakeDate.toLocaleString('vi-VN')}</p>
                    <p>B√¢y gi·ªù test l·∫°i c√°c ch·ª©c nƒÉng kh√°c ƒë·ªÉ xem h·ªá th·ªëng c√≥ b·ªã l·ª´a kh√¥ng.</p>
                `;
            } else {
                result.innerHTML = `
                    <p class="success">‚úÖ ƒê√£ reset v·ªÅ th·ªùi gian b√¨nh th∆∞·ªùng</p>
                `;
            }
        }

        async function testProgress() {
            const result = document.getElementById('progressResult');
            result.style.display = 'block';

            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);

            // T√≠nh v·ªõi client time
            const clientNow = new Date();
            const clientProgress = ((clientNow - startDate) / (endDate - startDate)) * 100;
            const clientDaysRemaining = Math.ceil((endDate - clientNow) / (1000 * 60 * 60 * 24));

            // T√≠nh v·ªõi server time (n·∫øu c√≥)
            let serverProgress = clientProgress;
            let serverDaysRemaining = clientDaysRemaining;
            if (serverTime) {
                const serverNow = new Date(new Date().getTime() + timeOffset);
                serverProgress = ((serverNow - startDate) / (endDate - startDate)) * 100;
                serverDaysRemaining = Math.ceil((endDate - serverNow) / (1000 * 60 * 60 * 24));
            }

            const daysDiff = Math.abs(serverDaysRemaining - clientDaysRemaining);

            result.innerHTML = `
                <h3>K·∫øt qu·∫£ t√≠nh to√°n:</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>üì± Client Time</h4>
                        <p><strong>Progress:</strong> ${clientProgress.toFixed(2)}%</p>
                        <p><strong>C√≤n l·∫°i:</strong> ${clientDaysRemaining} ng√†y</p>
                    </div>
                    <div>
                        <h4>üñ•Ô∏è Server Time</h4>
                        <p><strong>Progress:</strong> ${serverProgress.toFixed(2)}%</p>
                        <p><strong>C√≤n l·∫°i:</strong> ${serverDaysRemaining} ng√†y</p>
                    </div>
                </div>
                <p class="${daysDiff > 1 ? 'warning' : 'success'}">
                    <strong>Ch√™nh l·ªách:</strong> ${daysDiff} ng√†y
                    ${daysDiff > 1 ? '‚ö†Ô∏è Ph√°t hi·ªán client time b·ªã ch·ªânh s·ª≠a!' : '‚úì B√¨nh th∆∞·ªùng'}
                </p>
            `;
        }

        async function testTimeOffset() {
            const result = document.getElementById('offsetResult');
            result.style.display = 'block';

            if (!serverTime) {
                result.innerHTML = '<p class="warning">‚ö†Ô∏è Ch∆∞a fetch server time. Click "Test Server Time API" tr∆∞·ªõc.</p>';
                return;
            }

            const clientNow = new Date();
            const serverNow = new Date(clientNow.getTime() + timeOffset);
            const offsetMinutes = Math.abs(timeOffset) / (1000 * 60);
            const offsetHours = offsetMinutes / 60;

            result.innerHTML = `
                <h3>Time Offset Detection:</h3>
                <p><strong>Client Time:</strong> ${clientNow.toLocaleString('vi-VN')}</p>
                <p><strong>Server Time (calculated):</strong> ${serverNow.toLocaleString('vi-VN')}</p>
                <p><strong>Offset:</strong> ${offsetMinutes.toFixed(2)} ph√∫t (${offsetHours.toFixed(2)} gi·ªù)</p>
                <p class="${offsetMinutes > 5 ? 'warning' : 'success'}">
                    ${offsetMinutes > 5 ? 
                        '‚ö†Ô∏è Client time sai l·ªách ƒë√°ng k·ªÉ! H·ªá th·ªëng s·∫Ω s·ª≠ d·ª•ng server time.' : 
                        '‚úÖ Client time ch√≠nh x√°c, kh√¥ng ph√°t hi·ªán gian l·∫≠n.'}
                </p>
            `;
        }

        // Auto test server time khi load
        window.onload = () => {
            testServerTime();
        };
    </script>
</body>
</html>
