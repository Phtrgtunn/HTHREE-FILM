<!DOCTYPE html>
<html>
<head>
    <title>Test Create Subscription</title>
</head>
<body>
    <h1>Test Tạo Subscription Trực Tiếp</h1>
    <button onclick="createSubscription()">Tạo Subscription cho User 111</button>
    <div id="result"></div>

    <script>
        async function createSubscription() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Đang tìm đơn hàng mới nhất...';
            
            try {
                // Tìm đơn hàng mới nhất của user 111
                const ordersResponse = await fetch('http://localhost/HTHREE_film/backend/api/admin/orders.php?limit=10');
                const ordersData = await ordersResponse.json();
                
                if (!ordersData.success || !ordersData.data.length) {
                    throw new Error('Không tìm thấy đơn hàng nào');
                }
                
                // Tìm đơn hàng của user 111 (Phạm Trung Tuấn)
                const userOrder = ordersData.data.find(order => 
                    order.customer_name.includes('Phạm Trung Tuấn') || 
                    order.customer_email === 'vngs004@gmail.com'
                );
                
                if (!userOrder) {
                    throw new Error('Không tìm thấy đơn hàng của user 111');
                }
                
                resultDiv.innerHTML = `Đang kích hoạt đơn hàng ID: ${userOrder.id}...`;
                
                // Tạo subscription trực tiếp trong database
                const response = await fetch('http://localhost/HTHREE_film/backend/api/admin/orders.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'approve',
                        order_id: userOrder.id
                    })
                });
                
                const data = await response.json();
                console.log('Response:', data);
                
                resultDiv.innerHTML = `
                    <h3>Kết quả:</h3>
                    <p><strong>Success:</strong> ${data.success}</p>
                    <p><strong>Message:</strong> ${data.message}</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                
                // Kiểm tra subscription
                if (data.success) {
                    setTimeout(async () => {
                        const checkResponse = await fetch('http://localhost/HTHREE_film/backend/api/user_subscription.php?user_id=111');
                        const checkData = await checkResponse.json();
                        
                        resultDiv.innerHTML += `
                            <h3>Kiểm tra Subscription:</h3>
                            <pre>${JSON.stringify(checkData, null, 2)}</pre>
                        `;
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Error:', error);
                resultDiv.innerHTML = `<p style="color: red;">Lỗi: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>